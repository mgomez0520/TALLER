<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Configurar Google Sheets - Alberto Ochoa</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .config-container {
      max-width: 800px;
      margin: 2rem auto;
      padding: 2rem;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .step {
      margin: 2rem 0;
      padding: 1.5rem;
      background: #f5f5f5;
      border-radius: 8px;
      border-left: 4px solid #dc143c;
    }
    .step h3 {
      color: #dc143c;
      margin-top: 0;
    }
    .step code {
      background: #333;
      color: #fff;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
      font-size: 0.9rem;
    }
    .input-group {
      margin: 1rem 0;
    }
    .input-group label {
      display: block;
      font-weight: bold;
      margin-bottom: 0.5rem;
      color: #333;
    }
    .input-group input {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
      box-sizing: border-box;
    }
    .input-group input:focus {
      outline: none;
      border-color: #dc143c;
    }
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
      margin-right: 1rem;
      transition: background 0.3s;
    }
    .btn-primary {
      background: #dc143c;
      color: white;
    }
    .btn-primary:hover {
      background: #b01030;
    }
    .btn-secondary {
      background: #666;
      color: white;
    }
    .btn-secondary:hover {
      background: #555;
    }
    .status {
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 4px;
      display: none;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }
    .link {
      color: #dc143c;
      text-decoration: none;
      font-weight: bold;
    }
    .link:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="config-container">
    <h1>üîß Configuraci√≥n Google Sheets</h1>
    <p>Sigue estos pasos para conectar el sistema con Google Sheets y tener sincronizaci√≥n en tiempo real.</p>

    <!-- PASO 1 -->
    <div class="step">
      <h3>üìù Paso 1: Crear Google Sheet</h3>
      <ol>
        <li>Abre <a href="https://sheets.google.com" target="_blank" class="link">Google Sheets</a></li>
        <li>Crea una nueva hoja de c√°lculo</li>
        <li>N√≥mbrala: <code>Gesti√≥n Taller - Alberto Ochoa</code></li>
        <li>Crea 2 hojas (pesta√±as) con estos nombres exactos:
          <ul>
            <li><code>Reportes</code></li>
            <li><code>Proveedores</code></li>
          </ul>
        </li>
        <li>En la hoja <code>Reportes</code>, agrega estos encabezados en la fila 1:
          <br><small>A1: id | B1: numero_vehiculo | C1: estado | D1: descripcion | E1: tecnico_asignado | F1: taller_asignado | G1: diagnostico | H1: analisis | I1: requiere_reparacion | J1: notas | K1: prueba_ruta | L1: fecha_reporte | M1: fecha_actualizacion</small>
        </li>
        <li>En la hoja <code>Proveedores</code>, agrega estos encabezados en la fila 1:
          <br><small>A1: id | B1: nombre | C1: tipo | D1: contacto | E1: telefono | F1: email</small>
        </li>
      </ol>
    </div>

    <!-- PASO 2 -->
    <div class="step">
      <h3>üìù Paso 2: Crear Apps Script</h3>
      <ol>
        <li>En tu Google Sheet, ve a <strong>Extensiones ‚Üí Apps Script</strong></li>
        <li>Borra el c√≥digo por defecto</li>
        <li>Copia y pega el c√≥digo del archivo <code>SCRIPT-GOOGLE-APPS.txt</code></li>
        <li>Haz clic en <strong>üíæ Guardar</strong></li>
      </ol>
    </div>

    <!-- PASO 3 -->
    <div class="step">
      <h3>üöÄ Paso 3: Implementar como Aplicaci√≥n Web</h3>
      <ol>
        <li>En Apps Script, haz clic en <strong>Implementar ‚Üí Nueva implementaci√≥n</strong></li>
        <li>Haz clic en el icono ‚öôÔ∏è y selecciona <strong>Aplicaci√≥n web</strong></li>
        <li>Configuraci√≥n:
          <ul>
            <li><strong>Ejecutar como:</strong> Yo</li>
            <li><strong>Qui√©n tiene acceso:</strong> Cualquier persona</li>
          </ul>
        </li>
        <li>Haz clic en <strong>Implementar</strong></li>
        <li>Autoriza los permisos necesarios</li>
        <li><strong>Copia la URL</strong> que se genera (algo como <code>https://script.google.com/macros/s/...</code>)</li>
      </ol>
    </div>

    <!-- FORMULARIO -->
    <div class="step">
      <h3>‚öôÔ∏è Paso 4: Configurar en el Sistema</h3>
      
      <div class="input-group">
        <label for="scriptUrl">URL del Apps Script:</label>
        <input type="text" id="scriptUrl" placeholder="https://script.google.com/macros/s/...">
      </div>

      <button class="btn btn-primary" onclick="guardarConfiguracion()">üíæ Guardar Configuraci√≥n</button>
      <button class="btn btn-secondary" onclick="verificarConexion()">üîç Verificar Conexi√≥n</button>
      <button class="btn btn-secondary" onclick="migrarDatos()">üì§ Migrar Datos a Sheets</button>

      <div id="status" class="status"></div>
    </div>

    <div class="step">
      <h3>‚ÑπÔ∏è Informaci√≥n</h3>
      <p><strong>Estado actual:</strong> <span id="estadoActual">No configurado</span></p>
      <p><strong>√öltima sincronizaci√≥n:</strong> <span id="ultimaSync">Nunca</span></p>
      <button class="btn btn-secondary" onclick="window.location.href='index.html'">‚Üê Volver al Sistema</button>
    </div>
  </div>

  <script src="google-apps-script.js"></script>
  <script>
    // Verificar estado actual
    window.addEventListener('DOMContentLoaded', () => {
      const scriptUrl = localStorage.getItem('google_script_url');
      
      if (scriptUrl) {
        document.getElementById('scriptUrl').value = scriptUrl;
        document.getElementById('estadoActual').textContent = '‚úÖ Configurado';
        document.getElementById('estadoActual').style.color = '#28a745';
        googleSheets.configure(scriptUrl);
      } else {
        document.getElementById('estadoActual').textContent = '‚ùå No configurado';
        document.getElementById('estadoActual').style.color = '#dc3545';
      }
    });

    function guardarConfiguracion() {
      const scriptUrl = document.getElementById('scriptUrl').value.trim();
      
      if (!scriptUrl) {
        mostrarEstado('error', '‚ùå Por favor ingresa la URL del Apps Script');
        return;
      }

      googleSheets.configure(scriptUrl);
      document.getElementById('estadoActual').textContent = '‚úÖ Configurado';
      document.getElementById('estadoActual').style.color = '#28a745';
      mostrarEstado('success', '‚úÖ Configuraci√≥n guardada correctamente');
    }

    async function verificarConexion() {
      mostrarEstado('', 'Verificando conexi√≥n...');
      
      const resultado = await googleSheets.verificarConexion();
      
      if (resultado.success) {
        mostrarEstado('success', `‚úÖ Conexi√≥n exitosa\nHoja: ${resultado.title}\nPesta√±as encontradas: ${resultado.sheets.join(', ')}`);
      } else {
        mostrarEstado('error', `‚ùå Error de conexi√≥n: ${resultado.error}\n\nVerifica que:\n1. El API Key sea correcto\n2. El ID de la hoja sea correcto\n3. Google Sheets API est√© habilitada\n4. La hoja sea p√∫blica (solo lectura)`);
      }
    }

    async function migrarDatos() {
      if (!googleSheets.isConfigured()) {
        mostrarEstado('error', '‚ùå Primero debes configurar Google Sheets');
        return;
      }

      mostrarEstado('', 'Migrando datos a Google Sheets...');

      try {
        // Leer datos del localStorage
        const reportes = googleSheets.leerLocalStorage('gestion_taller_reportes');
        const proveedores = googleSheets.leerLocalStorage('gestion_taller_proveedores');

        // Guardar en Google Sheets
        await googleSheets.guardarReportes(reportes);
        await googleSheets.guardarProveedores(proveedores);

        mostrarEstado('success', `‚úÖ Migraci√≥n completada\n${reportes.length} reportes y ${proveedores.length} proveedores subidos a Google Sheets`);
        document.getElementById('ultimaSync').textContent = new Date().toLocaleString();
      } catch (error) {
        mostrarEstado('error', `‚ùå Error en la migraci√≥n: ${error.message}`);
      }
    }

    function mostrarEstado(tipo, mensaje) {
      const status = document.getElementById('status');
      status.className = `status ${tipo}`;
      status.textContent = mensaje;
      status.style.display = 'block';
      status.style.whiteSpace = 'pre-line';
    }
  </script>
</body>
</html>

// ========================================
//   SCRIPT PARA GOOGLE APPS SCRIPT
//   Copiar este código en Extensiones > Apps Script
// ========================================

function doGet(e) {
  return handleRequest(e);
}

function doPost(e) {
  return handleRequest(e);
}

function handleRequest(e) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet();
  const action = e.parameter.action;
  
  try {
    if (action === 'leer') {
      return leerDatos(sheet);
    } else if (action === 'guardar') {
      return guardarDatos(sheet, e);
    } else if (action === 'ping') {
      return ContentService.createTextOutput(JSON.stringify({
        success: true,
        message: 'Conexión exitosa'
      })).setMimeType(ContentService.MimeType.JSON);
    }
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({
      success: false,
      error: error.toString()
    })).setMimeType(ContentService.MimeType.JSON);
  }
}

function leerDatos(sheet) {
  const reportesSheet = sheet.getSheetByName('Reportes');
  const data = reportesSheet.getDataRange().getValues();
  
  // Saltar la fila de encabezados
  const rows = data.slice(1);
  
  const reportes = rows.map(row => ({
    id: row[0],
    numero_vehiculo: row[1],
    estado: row[2],
    descripcion: row[3],
    tecnico_asignado: row[4] || null,
    taller_asignado: row[5] || null,
    diagnostico: row[6] || null,
    analisis: row[7] || null,
    requiere_reparacion: row[8] === 'true' ? true : (row[8] === 'false' ? false : null),
    notas: row[9] || '',
    prueba_ruta: row[10] === 'true',
    fecha_reporte: row[11],
    fecha_actualizacion: row[12]
  }));
  
  return ContentService.createTextOutput(JSON.stringify({
    success: true,
    data: reportes
  })).setMimeType(ContentService.MimeType.JSON);
}

function guardarDatos(sheet, e) {
  const reportesSheet = sheet.getSheetByName('Reportes');
  const datos = JSON.parse(e.parameter.datos);
  
  // Limpiar datos existentes (excepto encabezados)
  const lastRow = reportesSheet.getLastRow();
  if (lastRow > 1) {
    reportesSheet.deleteRows(2, lastRow - 1);
  }
  
  // Convertir datos a filas
  const rows = datos.map(r => [
    r.id,
    r.numero_vehiculo,
    r.estado,
    r.descripcion,
    r.tecnico_asignado || '',
    r.taller_asignado || '',
    r.diagnostico || '',
    r.analisis || '',
    r.requiere_reparacion === null ? '' : r.requiere_reparacion.toString(),
    r.notas || '',
    r.prueba_ruta ? 'true' : 'false',
    r.fecha_reporte,
    r.fecha_actualizacion
  ]);
  
  // Escribir datos
  if (rows.length > 0) {
    reportesSheet.getRange(2, 1, rows.length, 13).setValues(rows);
  }
  
  return ContentService.createTextOutput(JSON.stringify({
    success: true,
    message: `${rows.length} registros guardados`
  })).setMimeType(ContentService.MimeType.JSON);
}
